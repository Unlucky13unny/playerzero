<script>
function importStats() {
  const file = document.getElementById('screenshot').files[0];
  if (!file) return alert("Please upload a screenshot first.");

  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("screenshotPreview").src = reader.result;
    document.getElementById("screenshotPreview").style.display = 'block';
  };
  reader.readAsDataURL(file);

  const importBtn = document.getElementById("importBtn");
  const feedback = document.getElementById("feedback");
  importBtn.disabled = true;
  feedback.innerText = "Reading stats from your screenshot...";

  Tesseract.recognize(file, 'eng', { logger: m => console.log(m) })
    .then(({ data: { text } }) => {
      const distanceMatch = text.match(/Distance\s+Walked[:\s]*([\d,.]+)/i);
      const caughtMatch = text.match(/Pok[eé]mon\s+Caught[:\s]*([\d,]+)/i);
      const stopsMatch = text.match(/Pok[eé]Stops\s+Visited[:\s]*([\d,]+)/i);
      const xpMatch = text.match(/Total\s*XP[^0-9]*([\d,]+)/i) || text.match(/([\d,]+)\s*(?:XP|xP)/i);
      const dateMatch = text.match(/Start\s+Date[:\s]*([0-9]{1,2}\/[0-9]{1,2}\/[0-9]{4})/i);

      if (distanceMatch) document.getElementById('distanceWalked').value = distanceMatch[1].replace(/,/g, '');
      if (caughtMatch) document.getElementById('totalCaught').value = caughtMatch[1].replace(/,/g, '');
      if (stopsMatch) document.getElementById('totalStops').value = stopsMatch[1].replace(/,/g, '');
      if (xpMatch) document.getElementById('totalXP').value = xpMatch[1].replace(/,/g, '');
      if (dateMatch) document.getElementById('startDate').value = dateMatch[1];

      feedback.innerText = "Stats loaded successfully. Verify below.";
      importBtn.disabled = false;
    })
    .catch(err => {
      console.error("Tesseract error:", err);
      feedback.innerText = "⚠️ Error scanning image. Try a clearer screenshot.";
      importBtn.disabled = false;
    });
}

function calculateStats() {
  const trainer = document.getElementById("trainerNameInput").value || "@Trainer";
  const start = document.getElementById("startDate").value;
  const km = parseFloat(document.getElementById("distanceWalked").value);
  const caught = parseInt(document.getElementById("totalCaught").value);
  const stops = parseInt(document.getElementById("totalStops").value);
  const xp = parseInt(document.getElementById("totalXP").value);

  if (!start || isNaN(km) || isNaN(caught) || isNaN(stops) || isNaN(xp)) {
    alert("Please fill in all stats before generating your Grind Card.");
    return;
  }

  const daysPlayed = Math.floor((new Date() - new Date(start)) / (1000 * 60 * 60 * 24));

  document.getElementById("trainerName").innerText = trainer;
  document.getElementById("daysPlayedDisplay").innerText = `Days Played: ${daysPlayed}`;
  document.getElementById("startDateDisplay").innerHTML = `Start Date: <b>${start}</b>`;
  document.getElementById("distanceTotal").innerText = km.toLocaleString();
  document.getElementById("distancePerDay").innerText = (km / daysPlayed).toFixed(2);
  document.getElementById("catchesTotal").innerText = caught.toLocaleString();
  document.getElementById("catchesPerDay").innerText = (caught / daysPlayed).toFixed(2);
  document.getElementById("stopsTotal").innerText = stops.toLocaleString();
  document.getElementById("stopsPerDay").innerText = (stops / daysPlayed).toFixed(2);
  document.getElementById("xpTotal").innerText = xp.toLocaleString();
  document.getElementById("xpPerDay").innerText = Number((xp / daysPlayed).toFixed(2)).toLocaleString();

  document.getElementById("card").style.display = "block";
}

function downloadCard() {
  html2canvas(document.getElementById("card")).then(canvas => {
    const link = document.createElement("a");
    link.download = "grind_card.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
}
</script>
