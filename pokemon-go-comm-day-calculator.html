<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comm Day Calculator | PlayerZero</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #fff;
      color: #222;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      color: #111;
    }
    input[type="file"] {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    .button {
      display: inline-block;
      background-color: #d62828; /* RED */
      color: #fff;
      padding: 12px 24px;
      margin: 10px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .button:hover {
      background-color: #a91d1d;
    }
    .preview {
      max-width: 300px;
      margin: 1rem 0;
      border: 2px solid #333;
      border-radius: 8px;
    }
    .stats input {
      width: 80px;
      font-size: 1rem;
      padding: 0.4rem;
      margin: 0.25rem;
      border: 2px solid #ccc;
      border-radius: 6px;
      text-align: center;
    }
    .debug {
      font-family: monospace;
      text-align: left;
      max-width: 600px;
      margin: 2rem auto;
      white-space: pre-wrap;
      background: #f9f9f9;
      border: 1px dashed #ccc;
      padding: 1rem;
      display: none; /* Change to block for dev mode */
    }
  </style>
</head>
<body>

  <h1>Comm Day Calculator</h1>

  <h3>START Screenshot</h3>
  <input type="file" id="startUpload" accept="image/*"/><br/>
  <img id="startPreview" class="preview" /><br/>
  <button class="button" onclick="runAnchorOCR('start')">Import START Stats</button>

  <h3>END Screenshot</h3>
  <input type="file" id="endUpload" accept="image/*"/><br/>
  <img id="endPreview" class="preview" /><br/>
  <button class="button" onclick="runAnchorOCR('end')">Import END Stats</button>

  <h3>Stats</h3>
  <div class="stats">
    Start Seen: <input id="startSeen" readonly/>
    Start Caught: <input id="startCaught" readonly/><br/>
    End Seen: <input id="endSeen" readonly/>
    End Caught: <input id="endCaught" readonly/>
  </div>

  <div id="debug" class="debug"></div>

  <script>
    const previews = {
      start: document.getElementById('startPreview'),
      end: document.getElementById('endPreview')
    };
    const files = {};
    const debug = document.getElementById('debug');

    document.getElementById('startUpload').addEventListener('change', e => {
      const file = e.target.files[0];
      files['start'] = file;
      previews['start'].src = URL.createObjectURL(file);
    });

    document.getElementById('endUpload').addEventListener('change', e => {
      const file = e.target.files[0];
      files['end'] = file;
      previews['end'].src = URL.createObjectURL(file);
    });

    async function runAnchorOCR(type) {
      if (!files[type]) return alert("Upload an image first.");

      debug.innerText = `Running OCR on ${type.toUpperCase()} image...`;
      debug.style.display = "block";

      const result = await Tesseract.recognize(files[type], 'eng', {
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
        preserve_interword_spaces: 1
      });

      const words = result.data.words;

      debug.innerText = `OCR RESULTS for ${type.toUpperCase()}:\n\n` +
        words.map(w => `${w.text} [x:${w.bbox.x0}, y:${w.bbox.y0}]`).join('\n');

      let seenAnchor = null, caughtAnchor = null;

      for (let word of words) {
        const text = word.text.toLowerCase();
        if (text.includes('seen') && !seenAnchor) seenAnchor = word;
        if (text.includes('caught') && !caughtAnchor) caughtAnchor = word;
      }

      const findClosestNumberBelow = (anchor) => {
        if (!anchor) return '';
        const anchorY = anchor.bbox.y1;
        const anchorX = anchor.bbox.x0;
        const candidates = words.filter(w => {
          return /^\d+$/.test(w.text) &&
            w.bbox.y0 > anchorY &&
            Math.abs(w.bbox.x0 - anchorX) < 100;
        });
        return candidates.length ? candidates[0].text : '';
      };

      const seenVal = findClosestNumberBelow(seenAnchor);
      const caughtVal = findClosestNumberBelow(caughtAnchor);

      document.getElementById(type + 'Seen').value = seenVal;
      document.getElementById(type + 'Caught').value = caughtVal;

      debug.innerText += `\n\nExtracted:\nSeen: ${seenVal}\nCaught: ${caughtVal}`;
    }
  </script>

</body>
</html>
